<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Ed Alegrid">
    <title>Node-M2M Â· Demo v1.0</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    
    <!-- Custom styles for this template -->
    <link href="headers.css" rel="stylesheet">

    <!--<script src="../assets/dist/js/bootstrap.bundle.min.js"></script>-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

  </head>
  <body>

<!-- page content -->
<main>
  <h1 class="visually-hidden">Headers examples</h1>

  <div class="container">
    <header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
      <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
        <span class="fs-5">Node-M2M WebSocket Application Integration Demo</span>
      </a>
    </header>
  </div>
  
  <div class="container">
    <div class="row justify-content-evenly">

    <div class="col-6">
      Basic Remote Control Demo
      <div class="card mt-3" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Device Actuator Remote Control</h6>
          <p class="card-text">Switch on/off device 100 and 200 gpio output pin 33 and 35.</p>
          <div class="row justify-content-start">
            <div class="col-6">
              <a id="deviceOn" style="width:100px;" class="btn btn-primary" role="button" >ON</a>
              <a id="deviceOff" style="width:100px;" class="btn btn-primary" role="button" >OFF</a>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg1" style="height:38px;padding:7px;"></div>    
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="card" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Device Actuator Remote Control (toggle button)</h6>
          <p class="card-text">Switch on/off device 100 gpio output pin 33.</p>
          <div class="row justify-content-start">
            <div class="col-6">
              <a id="deviceToggle" style="width:200px;" class="btn btn-primary" role="button" >ON/OFF</a>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg2" style="height:38px;padding:7px;"></div>    
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="card" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Device Actuator Remote Control (toggle switch)</h6>
          <p class="card-text">Switch on/off device 200 gpio output pin 33 and 35.</p>
          <div class="row justify-content-start">
            <div class="col-1"></div>
            <div class="col-4">
              <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" role="switch" id="device-control1" >
                <label class="form-check-label" for="device-control1"> pin 33</label>
              </div>
              <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" role="switch" id="device-control2" checked>
                <label class="form-check-label" for="device-control2"> pin 35</label>
              </div>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg3" style="height:30px;padding:0px;"></div>
              <div class="border text-center" id="msg4" style="height:30px;padding:0px;"></div>       
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="card" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Get current state of Device Input</h6>
          <p class="card-text">Get current state of device 100 gpio input pin 11. Press on/off the sw connected on pin 11</p>
          <div class="row justify-content-start">
            <div class="col-6">
              <a id="get-state" style="width:200px;" class="btn btn-primary" role="button" >Get state</a>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg9" style="height:38px;padding:7px;"></div>    
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="card" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Watch state of Device Input</h6>
          <p class="card-text">Watch state of device 100 gpio input pin 11. Press on/off the sw connected on pin 11.</p>
          <div class="row justify-content-start">
            <div class="col-6">
              <a id="watch-state" style="width:200px;" class="btn btn-primary" role="button" >Watch state</a>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg10" style="height:38px;padding:7px;"></div>    
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="card" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Unwatch state of Device Input</h6>
          <p class="card-text">Unwatch state of device 100 gpio input pin 11.</p>
          <div class="row justify-content-start">
            <div class="col-6">
              <a id="unwatch-state" style="width:200px;" class="btn btn-primary" role="button" >Unwatch state</a>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg11" style="height:38px;padding:7px;"></div>    
            </div>
          </div>
        </div>
      </div>
    </div><!-- class="col-6" -->

    <div class="col-6">
      Capturing and sending data demo
      <div class="card mt-3" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Capture Data from Device</h6>
          <p class="card-text">Capture data from device 100 using <i>get-data</i> channel.</p>
          <div class="row justify-content-start">
            <div class="col-6">
              <a id="get-data" style="width:200px;" class="btn btn-primary" role="button" >Capture data</a>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg5" style="height:38px;padding:7px;"></div>    
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="card mt-0" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Send Data to Device</h6>
          <p class="card-text">Send data to device 100 using <i>send-data</i> channel.</p>
          <div class="row justify-content-start">
            <div class="col-6">
              <form class="row g-3">
                <div class="col-auto">
                  <label for="input-value" class="visually-hidden">Enter data</label>
                  <input id="input-value" type="text" class="form-control"  placeholder="Enter value">
                </div>
                <div class="col-auto">
                  <button id="send-data" style="width:200px;" type="button" class="btn btn-primary mb-0">Send data</button>
                </div>
              </form>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg6" style="height:38px;padding:7px;"></div>    
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="card" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Watch Data from Device</h6>
          <p class="card-text">Watch <i>random-number</i> channel data from device 200.</p>
          <div class="row justify-content-start">
            <div class="col-6">
              <a id="watch-data" style="width:200px;" class="btn btn-primary" role="button" >Watch data</a>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg7" style="height:38px;padding:7px;"></div>    
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="card" style="width:500px">
        <div class="card-body">
          <h6 class="card-title">Unwatch Data from Device</h6>
          <p class="card-text">Unwatch <i>random-number</i> channel data from device 200.</p>
          <div class="row justify-content-start">
            <div class="col-6">
              <a id="unwatch-data" style="width:200px;" class="btn btn-primary" role="button" >Unwatch data</a>
            </div>
            <div class="col-4 align-self-start">
              <div class="border text-center" id="msg8" style="height:38px;padding:7px;"></div>    
            </div>
          </div>
        </div>
      </div>
    </div><!-- class="col-6" -->

    </div><!-- row -->
  </div><!-- container-->

</main>

  <script>
  
  var remoteDevice = {id:100, pin:33, state:true};
  var device1 = {id:200, pin:33, state:true};
  var device2 = {id:200, pin:35, state:false};  

  if(document.getElementById("deviceOn")){
    document.getElementById("deviceOn").onclick = deviceOn;
  }

  if(document.getElementById("deviceOff")){
    document.getElementById("deviceOff").onclick = deviceOff;
  }

  if(document.getElementById("deviceToggle")){
    document.getElementById("deviceToggle").onclick = deviceToggle;
  }

  document.getElementById("device-control1").addEventListener('click', {
    handleEvent: event => deviceControl(1) 
  });

  document.getElementById("device-control2").addEventListener('click', {
    handleEvent: event => deviceControl(2)
  });

  document.getElementById("device-control1").addEventListener('click', {
    handleEvent: event => deviceControl(1) 
  });

  document.getElementById("device-control2").addEventListener('click', {
    handleEvent: event => deviceControl(2)
  });

  // turn off device 200 pin 33 on page loading 
  if(document.getElementById("device-control1")){
    let status = document.getElementById("device-control1").checked;
    console.log('status', status);
    if(status === false){
      msg = "msg3";
      device1 = {id:200, pin:33, state:false};
      setTimeout(() => {
        deviceControl(1);
      }, 100);
    }
  }

  // turn on device 200 pin 35 on page loading 
  if(document.getElementById("device-control2")){
    let status = document.getElementById("device-control2").checked;
    console.log('status', status);
    if(status){
      msg = "msg4";
      device2 = {id:200, pin:35, state:true};
      setTimeout(() => {
        deviceControl(2);
      }, 500);
    }
  }

  if(document.getElementById("get-state")){
    document.getElementById("get-state").onclick = getState;
  }

  if(document.getElementById("watch-state")){
    document.getElementById("watch-state").onclick = watchState;
  }

  if(document.getElementById("unwatch-state")){
    document.getElementById("unwatch-state").onclick = unwatchState;
  }

  if(document.getElementById("get-data")){
    document.getElementById("get-data").onclick = getData;
  }

  if(document.getElementById("send-data")){
    document.getElementById("send-data").onclick = sendData;
  }

  if(document.getElementById("watch-data")){
    document.getElementById("watch-data").onclick = watchData;
  }

  if(document.getElementById("unwatch-data")){
    document.getElementById("unwatch-data").onclick = unwatchData;
  }

  function processRcvdData(msgId, data){
    let msg = null;
    try{
      msg = JSON.parse(data);
      console.log('rcvd msg', msg);
      console.log('msgId', msgId);
      if(msg.state === true|| msg.state === false){
        if(msgId === "msg2"){
          if(msg.state){
            remoteDevice.state = false;
          }
          else{
            remoteDevice.state = true;
          }
        }
        else if(msgId === "msg3"){
          if(msg.state){
            device1.state = false;
          }
          else{
            device1.state = true;
          }
        }
        else if(msgId === "msg4"){
          if(msg.state){
            device2.state = false;
          }
          else{
            device2.state = true;
          }
        }
        return document.getElementById(msgId).innerHTML = msg.state;
      }
      else if(msg.channel){
        return document.getElementById(msgId).innerHTML = msg.data;
      }
    }
    catch(err){
      console.log('rcvd error', err);
      if(msg.state === true|| msg.state === false){
        return document.getElementById(msgId).innerHTML = err;
      }
      else if(msg.channel){
        return document.getElementById(msgId).innerHTML = err;
      }
    }
  }

  function wsClient(path, pl, msgId, cb){

    try{
      let ws = new WebSocket('ws://127.0.0.1:5000/' + path);
      ws.onopen = function(e) {
        if(ws.readyState === 1) {
          ws.send(JSON.stringify(pl));
        }
      };
      ws.onmessage = function (e) {
        if (ws.readyState === 1) {
           processRcvdData(msgId, e.data);
        }
      };
      ws.onerror = function(e) {
        console.log('wsClient ws onerror', e);
      };
      ws.onclose = function(e) {
        console.log('wsClient ws onclose', e);
      };
    }
    catch(e){
      console.log('wsClient catch error',e);
    }
  }

  function deviceOn(){
    console.log('deviceOn');
    wsClient('demo1', {id:[100, 200], pin:[33, 35], state:true}, 'msg1');
  }

  function deviceOff(){
    console.log('deviceOff');
    wsClient('demo1', {id:[100, 200], pin:[33, 35], state:false}, 'msg1');
  }

  function deviceToggle(){
    console.log('deviceToggle');
    wsClient('demo1', {id:100, pin:33, state:remoteDevice.state, toggle:true}, 'msg2');
  }

  function deviceControl(sel){
    console.log('deviceControl');
    let pin = null;
    if(sel === 1){
      pin = 33;
      wsClient('demo1', {id:200, pin:pin, state:device1.state, switch:true}, 'msg3');
    }
    else{
      pin = 35;
      wsClient('demo1', {id:200, pin:pin, state:device2.state, switch:true}, 'msg4');
    }
  }

  function getData(){
    console.log('getData');
    wsClient('demo2', {id:100, channel:'get-data', method:'getData'}, 'msg5');
  }

  function sendData(){
    console.log('sendData');
    let inputData = document.getElementById("input-value").value;
    wsClient('demo2', {id:100, channel:'send-data', method:'sendData', payload:inputData}, 'msg6');
  }

  function watchData(){
    console.log('watchData');
    wsClient('demo2', {id:200, channel:'random-number', method:'watchData'}, 'msg7');
  }

  function unwatchData(){
    console.log('unwatchData');
    wsClient('demo2', {id:200, channel:'random-number', method:'unwatchData'}, 'msg8');
  }

  function getState(){
    console.log('getState');
    wsClient('demo1', {id:100, pin:11, state:'', getState:true}, 'msg9');
  }

  function watchState(){
    console.log('watchState');
    wsClient('demo1', {id:100, pin:11, state:'', watch:true}, 'msg10');
  }

  function unwatchState(){
    console.log('unwatchState');
    wsClient('demo1', {id:100, pin:11, state:'', unwatch:true}, 'msg11');
  }   

  </script>
  <br>
  <footer class="footer mt-auto py-3 bg-light">
    <div class="container">
      <span class="text-muted">Node-M2M 2021</span>
    </div>
  </footer>

  </body>
</html>
